name: C/C++ CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux-ninja:
    name: Build (Linux, Ninja)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show runner and tool versions
        run: |
          uname -a || true
          cmake --version || true
          ninja --version || true

      - name: Configure with CMake (Ninja)
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -- -j$(nproc)

      - name: Run smoke tests
        run: |
          echo "Checking built binaries"
          server=build/bin/r-type_server
          client=build/bin/r-type_client
          ls -l "$(dirname "$server")" || true
          chmod +x "$server" || true
          "$server" || (echo "Server failed to run" && exit 1)
          "$client" || (echo "Client failed to run" && exit 1)

      - name: Upload built binaries
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: built-binaries-linux-ninja
          path: build/bin/**

  build-linux-make:
    name: Build (Linux, Make)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure with CMake (Unix Makefiles)
        run: cmake -S . -B build -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -- -j$(nproc)

      - name: Run smoke tests
        run: |
          echo "Checking built binaries"
          server=build/bin/r-type_server
          client=build/bin/r-type_client
          ls -l "$(dirname "$server")" || true
          chmod +x "$server" || true
          "$server" || (echo "Server failed to run" && exit 1)
          "$client" || (echo "Client failed to run" && exit 1)

      - name: Upload built binaries
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: built-binaries-linux-make
          path: build/bin/**

  build-windows-vs:
    name: Build (Windows, Visual Studio 2022)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show runner and tool versions
        shell: powershell
        run: |
          Write-Host "OS: $($PSVersionTable.OS)"
          cmake --version || Write-Host "cmake not found"

      - name: Configure with CMake (Visual Studio)
        shell: powershell
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      - name: Build
        shell: powershell
        run: cmake --build build --config Release -- /m

      - name: Run smoke tests
        shell: powershell
        run: |
          Write-Host "Checking built binaries"
          $server = "build\\bin\\Release\\r-type_server.exe"
          $client = "build\\bin\\Release\\r-type_client.exe"
          Get-ChildItem (Split-Path $server) -ErrorAction SilentlyContinue
          & $server; if ($LASTEXITCODE -ne 0) { Write-Error "Server failed to run"; exit 1 }
          & $client; if ($LASTEXITCODE -ne 0) { Write-Error "Client failed to run"; exit 1 }

      - name: Upload built binaries
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: built-binaries-windows-vs
          path: build/bin/**
                      # Use x64 for Visual Studio generator
